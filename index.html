<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ship Tetris ‚Äî –§—Ä–∞—Ö—Ç–æ–≤—ã–π –¢–µ—Ç—Ä–∏—Å (Mobile One‚ÄëFile)</title>
  <meta name="theme-color" content="#0b1520">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    :root { --bg:#0b1520; --panel:#102033; --panel-border:#1e3350; --ink:#e8f0f7; --muted:#a7bed3; --accent:#2b8a3e; --accent-2:#274365; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;color:var(--ink);background:#0b1520;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;touch-action:manipulation}
    #app{max-width:1100px;margin:0 auto;padding:16px}
    .topbar{display:flex;align-items:baseline;gap:16px}.topbar h1{margin:8px 0 16px;font-weight:800}
    .screen{display:none}.screen.active{display:block}
    .card{background:#102033;border:1px solid var(--panel-border);border-radius:16px;padding:16px;box-shadow:0 8px 32px rgba(0,0,0,.25)}
    .card h2,.card h3{margin:8px 0 12px;font-weight:700}.card.mini{padding:12px;border-radius:12px}
    .row{display:flex;align-items:center;gap:12px;margin:10px 0} select,button{font:inherit}
    select{background:#0f1d2d;color:var(--ink);border:1px solid var(--accent-2);border-radius:10px;padding:8px 12px}
    button{cursor:pointer;border-radius:12px;padding:10px 16px;border:1px solid transparent}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent)} button.primary:hover{filter:brightness(1.06)}
    button.ghost{background:transparent;color:var(--ink);border-color:var(--accent-2)} button.ghost:hover{background:#0f1d2d}
    .hint{opacity:.85;margin:10px 0 16px}
    .hud{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px}
    .hud .hud-item{background:#0f1d2d;border:1px solid var(--panel-border);border-radius:10px;padding:8px 10px}
    .hud .label{opacity:.8;margin-right:6px}
    .playfield-wrap{display:grid;grid-template-columns:auto 280px;gap:16px;align-items:start}
    canvas#board{background:#07101a;border:2px solid var(--panel-border);border-radius:12px;display:block;max-width:100%;height:auto;touch-action:none}
    .sidebar{display:grid;gap:12px}
    .warnings{min-height:56px;color:#ffd166}
    .keys{margin:0;padding-left:18px;opacity:.85}
    .result-grid{display:grid;grid-template-columns:repeat(2,minmax(180px, 1fr));gap:10px;margin:8px 0 16px}
    .buttons{display:flex;gap:10px;flex-wrap:wrap}

    /* Touch controls */
    .touch-controls{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:14px 0 6px}
    .tc-btn{background:#0f1d2d;border:1px solid var(--panel-border);border-radius:12px;padding:14px 10px;color:var(--ink);font-weight:800;text-align:center;user-select:none;-webkit-user-select:none;touch-action:none}
    .tc-btn.emph{background:#2b8a3e;border-color:#2b8a3e;color:#fff}

    @media (max-width: 900px){ .playfield-wrap{ grid-template-columns:1fr; } .sidebar{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
    @media (max-width: 560px){ .topbar h1{ font-size:20px; } .card{ padding:12px; } .row{ flex-wrap:wrap; } .sidebar{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <noscript><div style="padding:12px; background:#8b0000; color:#fff">–í–∫–ª—é—á–∏—Ç–µ JavaScript, —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å.</div></noscript>

  <div id="app">
    <header class="topbar">
      <h1>üö¢ Ship Tetris ‚Äî –§—Ä–∞—Ö—Ç–æ–≤—ã–π –¢–µ—Ç—Ä–∏—Å</h1>
    </header>

    <!-- –ú–µ–Ω—é -->
    <section id="screen-menu" class="screen active">
      <div class="card">
        <h2>–ù–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—É–¥–Ω–∞</h2>
        <div class="row">
          <label>–†–∞–∑–º–µ—Ä —Å—É–¥–Ω–∞:</label>
          <select id="ship-size">
            <option value="small">–ú–∞–ª–æ–µ (8√ó14, 8 000 —Ç)</option>
            <option value="medium" selected>–°—Ä–µ–¥–Ω–µ–µ (10√ó16, 20 000 —Ç)</option>
            <option value="large">–ö—Ä—É–ø–Ω–æ–µ (12√ó18, 35 000 —Ç)</option>
          </select>
        </div>
        <div class="row">
          <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–µ–π—Å–∞:</label>
          <select id="game-duration">
            <option value="90">90 —Å–µ–∫</option>
            <option value="120" selected>120 —Å–µ–∫</option>
            <option value="180">180 —Å–µ–∫</option>
          </select>
        </div>
        <div class="hint">–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞: ‚Üê ‚Üí ‚Üì, R/‚Üë, –ü—Ä–æ–±–µ–ª, P. –ù–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–µ ‚Äî –∫–Ω–æ–ø–∫–∏ –ø–æ–¥ —Ö–æ–ª—Å—Ç–æ–º.</div>
        <button id="btn-start" class="primary">–ò–≥—Ä–∞—Ç—å</button>
      </div>
    </section>

    <!-- –ò–≥—Ä–∞ -->
    <section id="screen-game" class="screen">
      <div class="hud">
        <div class="hud-item"><span class="label">–°—É–¥–Ω–æ:</span> <span id="hud-size"></span></div>
        <div class="hud-item"><span class="label">–î–µ–¥–≤–µ–π—Ç:</span> <span id="hud-dwt"></span> —Ç</div>
        <div class="hud-item"><span class="label">–í–µ—Å:</span> <span id="hud-weight">0</span> —Ç</div>
        <div class="hud-item"><span class="label">–î–æ—Ö–æ–¥:</span> $<span id="hud-revenue">0</span></div>
        <div class="hud-item"><span class="label">–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ:</span> <span id="hud-fill">0</span>%</div>
        <div class="hud-item"><span class="label">–í—Ä–µ–º—è:</span> <span id="hud-time">0 —Å–µ–∫</span></div>
        $1
        <button id="btn-audio" class="ghost">–ó–≤—É–∫: üîä</button>
      </div>

      <div class="playfield-wrap">
        <canvas id="board" width="300" height="480" aria-label="–¢—Ä—é–º —Å—É–¥–Ω–∞"></canvas>
        <div class="sidebar">
          <div class="card mini">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <ul class="keys">
              <li>‚Üê / ‚Üí ‚Äî –¥–≤–∏–≥–∞—Ç—å</li>
              <li>‚Üì ‚Äî –±—ã—Å—Ç—Ä–µ–µ</li>
              <li>R / ‚Üë ‚Äî –≤—Ä–∞—â–∞—Ç—å</li>
              <li>–ü—Ä–æ–±–µ–ª ‚Äî —É—Ä–æ–Ω–∏—Ç—å</li>
              <li>P ‚Äî –ø–∞—É–∑–∞</li>
              <li>X ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≥—Ä—É–∑</li>
            </ul>
          </div>
          <div class="card mini"><h3>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</h3><div id="warnings" class="warnings"></div></div>
          <div class="card mini">
            <h3>–°–ª–µ–¥—É—é—â–∏–π –≥—Ä—É–∑</h3>
            <canvas id="next" width="120" height="120"></canvas>
            <div class="meta">
              <div>–í–µ—Å: <span id="meta-weight">‚Äî</span> —Ç</div>
              <div>–î–æ—Ö–æ–¥: $<span id="meta-revenue">‚Äî</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
      <div class="touch-controls" aria-label="–ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
        <button id="tc-left"   class="tc-btn" aria-label="–í–ª–µ–≤–æ">‚üµ</button>
        <button id="tc-rotate" class="tc-btn" aria-label="–ü–æ–≤–µ—Ä–Ω—É—Ç—å">‚ü≥</button>
        <button id="tc-right"  class="tc-btn" aria-label="–í–ø—Ä–∞–≤–æ">‚ü∂</button>
        <button id="tc-down"   class="tc-btn" aria-label="–£—Å–∫–æ—Ä–∏—Ç—å">‚¨á</button>
        <button id="tc-drop"   class="tc-btn emph" aria-label="–£—Ä–æ–Ω–∏—Ç—å">DROP</button>
        <button id="tc-jett"   class="tc-btn" aria-label="–°–±—Ä–æ—Å–∏—Ç—å –≥—Ä—É–∑">–°–±—Ä–æ—Å</button>
        <button id="tc-pause"  class="tc-btn" aria-label="–ü–∞—É–∑–∞">‚è∏</button>
      </div>
    </section>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <section id="screen-result" class="screen">
      <div class="card">
        <h2>–ò—Ç–æ–≥–∏ —Ä–µ–π—Å–∞</h2>
        <div class="result-grid">
          <div><span class="label">–†–∞–∑–º–µ—Ä —Å—É–¥–Ω–∞:</span> <span id="res-size"></span></div>
          <div><span class="label">–î–µ–¥–≤–µ–π—Ç:</span> <span id="res-dwt"></span> —Ç</div>
          <div><span class="label">–§–∞–∫—Ç. –≤–µ—Å:</span> <span id="res-weight"></span> —Ç</div>
          <div><span class="label">–î–æ—Ö–æ–¥:</span> $<span id="res-revenue"></span></div>
          <div><span class="label">–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä—é–º–∞:</span> <span id="res-fill"></span>%</div>
          <div><span class="label">–í—Ä–µ–º—è –∏–≥—Ä—ã:</span> <span id="res-time"></span> —Å–µ–∫</div>
          <div><span class="label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</span> <span id="res-eff"></span></div>
        </div>
        <div class="buttons">
          <button id="btn-restart" class="primary">–ò–≥—Ä–∞—Ç—å –µ—â—ë</button>
          <button id="btn-menu" class="ghost">–í –º–µ–Ω—é</button>
        </div>
      </div>
    </section>
  </div>

  <script>
  (function(){
    const $=(s)=>document.querySelector(s); const on=(el,ev,fn,opt)=>el&&el.addEventListener(ev,fn,opt);
    const fmt=(t)=>{t=Math.max(0,Math.floor(t));const m=String(Math.floor(t/60)).padStart(2,'0');const s=String(t%60).padStart(2,'0');return `${m}:${s}`};

    // ===== Game data =====
    const SHIPS={small:{w:8,h:14,dwt:8000,label:'–ú–∞–ª–æ–µ 8√ó14'},medium:{w:10,h:16,dwt:20000,label:'–°—Ä–µ–¥–Ω–µ–µ 10√ó16'},large:{w:12,h:18,dwt:35000,label:'–ö—Ä—É–ø–Ω–æ–µ 12√ó18'}};
    const SHAPES=[{name:'–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä',m:[[1,1],[1,1]],wt:4,rev:9000,color:'#37a2ff'},{name:'–£–≥–æ–ª—å',m:[[1,1,1]],wt:3,rev:7000,color:'#a9a9a9'},{name:'–ó–µ—Ä–Ω–æ',m:[[1,1,1,1]],wt:5,rev:9000,color:'#ffd166'},{name:'–û–±–æ—Ä—É–¥.',m:[[1,1,1],[1,0,0]],wt:6,rev:14000,color:'#8be28b'},{name:'–ê–≤—Ç–æ',m:[[0,1,0],[1,1,1]],wt:6,rev:15000,color:'#ff6b6b'},{name:'Z',m:[[1,1,0],[0,1,1]],wt:6,rev:15000,color:'#c792ea'},{name:'S',m:[[0,1,1],[1,1,0]],wt:6,rev:15000,color:'#eab308'}];
    const clone=(m)=>m.map(r=>r.slice()); const rot=(m)=>{const h=m.length,w=m[0].length,res=Array.from({length:w},()=>Array(h).fill(0));for(let y=0;y<h;y++)for(let x=0;x<w;x++)res[x][h-1-y]=m[y][x];return res;};

    // ===== DOM =====
    const board=$('#board'), next=$('#next'); const bctx=board.getContext('2d'); const nctx=next.getContext('2d');
    const scrMenu=$('#screen-menu'), scrGame=$('#screen-game'), scrResult=$('#screen-result');
    const hudSize=$('#hud-size'), hudDwt=$('#hud-dwt'), hudWeight=$('#hud-weight'), hudRevenue=$('#hud-revenue'), hudFill=$('#hud-fill'), hudTime=$('#hud-time');
    const shipSizeSel=$('#ship-size'), durationSel=$('#game-duration');
    const btnStart=$('#btn-start'), btnPause=$('#btn-pause'), btnRestart=$('#btn-restart'), btnMenu=$('#btn-menu'), btnAudio=$('#btn-audio');
    const tcLeft=$('#tc-left'), tcRight=$('#tc-right'), tcRotate=$('#tc-rotate'), tcDown=$('#tc-down'), tcDrop=$('#tc-drop'), tcPause=$('#tc-pause');

    // ===== Audio (Web Audio API) =====
    let audioCtx=null, masterGain=null, audioEnabled=true;
    function initAudio(){
      if(!audioEnabled) return;
      if(!audioCtx){
        const AC = window.AudioContext || window.webkitAudioContext;
        if(!AC){ console.warn('WebAudio –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'); audioEnabled=false; return; }
        audioCtx = new AC();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.15; // –≥—Ä–æ–º–∫–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        masterGain.connect(audioCtx.destination);
      }
      if(audioCtx.state==='suspended') audioCtx.resume();
    }
    function setMasterVolume(v){ if(masterGain && audioCtx){ masterGain.gain.setValueAtTime(v, audioCtx.currentTime); } }
    function toggleAudio(){ audioEnabled = !audioEnabled; if(audioEnabled){ initAudio(); setMasterVolume(0.15); } else { setMasterVolume(0.0); } const b=btnAudio; if(b) b.textContent = audioEnabled ? '–ó–≤—É–∫: üîä' : '–ó–≤—É–∫: üîá'; }
    function playStartMelody(){
      if(!audioEnabled) return; initAudio(); if(!audioCtx) return;
      const now = audioCtx.currentTime + 0.05;
      const tempo = 110; const beat = 60/tempo; // —Å–µ–∫—É–Ω–¥–∞ –Ω–∞ —á–µ—Ç–≤–µ—Ä—Ç—å
      const notes = [
        {n:261.63, d:beat*0.75}, // C4
        {n:329.63, d:beat*0.75}, // E4
        {n:392.00, d:beat*0.75}, // G4
        {n:523.25, d:beat*1.0},  // C5
        {n:392.00, d:beat*0.75},
        {n:329.63, d:beat*0.75},
        {n:261.63, d:beat*1.2}
      ];
      let t = now;
      notes.forEach(({n,d})=>{
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(n, t);
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.6, t+0.02); // –∞—Ç–∞–∫–∞
        g.gain.exponentialRampToValueAtTime(0.001, t+d);  // —Ä–µ–ª–∏–∑
        osc.connect(g); g.connect(masterGain);
        osc.start(t); osc.stop(t+d+0.05);
        t += d; // —Ä–æ–≤–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
      });
    }

    // ===== Game state =====
    const st={gridW:10,gridH:16,cell:30,board:[],dwt:20000,curWeight:0,revenue:0,running:false,paused:false,over:false,durationSec:120,timeLeft:120,lastFall:0,lastClock:0,clockAccum:0,fallInterval:650,fallAcc:70,piece:null,nextPiece:null,px:0,py:0};
    let SHIP = SHIPS['medium'];

    const setScreen=(s)=>{[scrMenu,scrGame,scrResult].forEach(x=>x.classList.remove('active'));s.classList.add('active');};
    const initBoard=(w,h)=>{st.gridW=w;st.gridH=h;board.width=w*st.cell;board.height=h*st.cell;st.board=Array.from({length:h},()=>Array(w).fill(0));};
    const pick=()=>{const b=SHAPES[(Math.random()*SHAPES.length)|0];return {name:b.name,m:clone(b.m),wt:b.wt,rev:b.rev,color:b.color};};

    function spawn(){st.piece=st.nextPiece||pick();st.nextPiece=pick();st.px=Math.floor((st.gridW-st.piece.m[0].length)/2);st.py=-st.piece.m.length;updNext();if(collides(st.px,st.py,st.piece.m)) over('–¢—Ä—é–º —Å–≤–µ—Ä—Ö—É –∑–∞–ø–æ–ª–Ω–µ–Ω');}

    const collides=(px,py,m)=>{for(let y=0;y<m.length;y++)for(let x=0;x<m[0].length;x++){if(!m[y][x])continue;const gx=px+x,gy=py+y;if(gx<0||gx>=st.gridW||gy>=st.gridH)return true;if(gy>=0&&st.board[gy][gx])return true;}return false;};

    function lock(){
      const m=st.piece.m; for(let y=0;y<m.length;y++)for(let x=0;x<m[0].length;x++){
        if(!m[y][x]) continue; const gx=st.px+x, gy=st.py+y; if(gy>=0) st.board[gy][gx]={color:st.piece.color};
      }
      const nw=st.curWeight+st.piece.wt; if(nw>st.dwt){
        for(let y=0;y<m.length;y++)for(let x=0;x<m[0].length;x++){ if(!m[y][x]) continue; const gx=st.px+x, gy=st.py+y; if(gy>=0) st.board[gy][gx]=0; }
        warn(`–ü–µ—Ä–µ–≥—Ä—É–∑! –î–µ–¥–≤–µ–π—Ç ${st.dwt} —Ç. –¢–µ–∫—É—â–∏–π –≤–µ—Å: ${st.curWeight} —Ç. –ì—Ä—É–∑ ${st.piece.wt} —Ç –Ω–µ –ø—Ä–∏–Ω—è—Ç.`); return;
      }
      st.curWeight=nw; st.revenue+=st.piece.rev;
    }

    function warn(m){ const w=$('#warnings'); if(w) w.textContent=m; }
    function clr(){ const w=$('#warnings'); if(w) w.textContent=''; }

    const filled=()=>{let c=0;for(let y=0;y<st.gridH;y++)for(let x=0;x<st.gridW;x++)if(st.board[y][x])c++;return c;};
    function hud(){ $('#hud-size').textContent=SHIP.label; $('#hud-dwt').textContent=st.dwt; $('#hud-weight').textContent=st.curWeight; $('#hud-revenue').textContent=st.revenue; const f=Math.round(100*filled()/(st.gridW*st.gridH)); $('#hud-fill').textContent=f; $('#hud-time').textContent=`${st.timeLeft} —Å–µ–∫`; }

    function cell(ctx,x,y,c){const s=st.cell;ctx.fillStyle=c;ctx.fillRect(x*s,y*s,s,s);ctx.strokeStyle='rgba(0,0,0,.35)';ctx.lineWidth=2;ctx.strokeRect(x*s+1,y*s+1,s-2,s-2);}    
    function draw(){ bctx.clearRect(0,0,board.width,board.height); for(let y=0;y<st.gridH;y++)for(let x=0;x<st.gridW;x++){ bctx.fillStyle=(x%2===0&&y%2===0)?'#0b1b2a':'#091621'; bctx.fillRect(x*st.cell,y*st.cell,st.cell,st.cell); bctx.strokeStyle='#0f2a45'; bctx.strokeRect(x*st.cell,y*st.cell,st.cell,st.cell);} for(let y=0;y<st.gridH;y++)for(let x=0;x<st.gridW;x++){ const c=st.board[y][x]; if(c) cell(bctx,x,y,c.color); } if(st.piece){ const m=st.piece.m; for(let y=0;y<m.length;y++)for(let x=0;x<m[0].length;x++){ if(!m[y][x]) continue; const gx=st.px+x, gy=st.py+y; if(gy>=0) cell(bctx,gx,gy,st.piece.color); } } }

    function updNext(){ const metaW=$('#meta-weight'), metaR=$('#meta-revenue'); nctx.clearRect(0,0,next.width,next.height); if(!st.nextPiece){ if(metaW) metaW.textContent='‚Äî'; if(metaR) metaR.textContent='‚Äî'; return; } if(metaW) metaW.textContent=st.nextPiece.wt; if(metaR) metaR.textContent=st.nextPiece.rev; const m=st.nextPiece.m,cs=20,w=m[0].length*cs,h=m.length*cs,ox=(next.width-w)/2,oy=(next.height-h)/2; for(let y=0;y<m.length;y++)for(let x=0;x<m[0].length;x++){ if(!m[y][x]) continue; nctx.fillStyle=st.nextPiece.color; nctx.fillRect(ox+x*cs,oy+y*cs,cs,cs); nctx.strokeStyle='rgba(0,0,0,.35)'; nctx.lineWidth=2; nctx.strokeRect(ox+x*cs+1,oy+y*cs+1,cs-2,cs-2); } }

    // ===== Main loop: real-time seconds + fall timer =====
    function loop(ts){
      if(!st.running) return; if(st.paused){ requestAnimationFrame(loop); return; }
      if(!st.lastClock) st.lastClock=ts; if(!st.lastFall) st.lastFall=ts;
      const dtClock = ts - st.lastClock; st.lastClock = ts; st.clockAccum += dtClock;
      if(st.clockAccum >= 1000){ const whole=Math.floor(st.clockAccum/1000); st.timeLeft=Math.max(0, st.timeLeft - whole); st.clockAccum -= whole*1000; if(st.timeLeft===0){ over('–í—Ä–µ–º—è –≤—ã—à–ª–æ'); return; } }
      const interval = keys.has('ArrowDown') ? st.fallAcc : st.fallInterval; const dtFall = ts - st.lastFall; if(dtFall >= interval){ st.lastFall = ts; fall(); }
      hud(); draw(); requestAnimationFrame(loop);
    }

    function fall(){ if(!st.piece) return; if(!collides(st.px,st.py+1,st.piece.m)) st.py++; else { lock(); clr(); spawn(); } }
    function drop(){ while(!collides(st.px,st.py+1,st.piece.m)) st.py++; lock(); clr(); spawn(); }
    function move(dx){ if(!st.piece) return; const nx=st.px+dx; if(!collides(nx,st.py,st.piece.m)) st.px=nx; }
    function rotate(){ if(!st.piece) return; const r=rot(st.piece.m); if(!collides(st.px,st.py,r)) st.piece.m=r; else if(!collides(st.px-1,st.py,r)){ st.px-=1; st.piece.m=r; } else if(!collides(st.px+1,st.py,r)){ st.px+=1; st.piece.m=r; } }

    const keys=new Set();
    on(window,'keydown',(e)=>{ if(!st.running) return; keys.add(e.key); if(e.key==='ArrowLeft'){e.preventDefault(); move(-1);} if(e.key==='ArrowRight'){e.preventDefault(); move(1);} if(e.key==='ArrowUp'||e.key==='r'||e.key==='R'){e.preventDefault(); rotate();} if(e.key===' '){e.preventDefault(); drop();} if(e.key==='p'||e.key==='P'){ pause(); } }, {passive:false});
    on(window,'keyup',(e)=> keys.delete(e.key));

    function pause(){ if(!st.running) return; st.paused=!st.paused; const p=$('#btn-pause'); if(p) p.textContent=st.paused?'–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å':'–ü–∞—É–∑–∞'; }

    function start(){
      SHIP = SHIPS[shipSizeSel.value]; const dur=Number(durationSel.value);
      initBoard(SHIP.w,SHIP.h); st.dwt=SHIP.dwt; st.curWeight=0; st.revenue=0; st.over=false; st.running=true; st.paused=false;
      st.durationSec=dur; st.timeLeft=dur; st.lastFall=0; st.lastClock=0; st.clockAccum=0;
      $('#hud-size').textContent=SHIP.label; $('#hud-dwt').textContent=SHIP.dwt; $('#res-size').textContent=SHIP.label; $('#res-dwt').textContent=SHIP.dwt;
      clr(); st.nextPiece=pick(); spawn(); setScreen(scrGame);
      const p=$('#btn-pause'); if(p) p.textContent='–ü–∞—É–∑–∞';
      // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –º–µ–ª–æ–¥–∏—é —Å—Ç–∞—Ä—Ç–∞
      playStartMelody();
      requestAnimationFrame(loop);
    }

    function over(reason){ st.running=false; st.over=true; $('#res-weight').textContent=st.curWeight; $('#res-revenue').textContent=st.revenue; const f=Math.round(100*filled()/(st.gridW*st.gridH)); $('#res-fill').textContent=f; $('#res-time').textContent = String(Math.max(0, Math.round(st.durationSec - st.timeLeft))); const eff=((st.revenue/Math.max(1,st.dwt))*(f/100)).toFixed(3); $('#res-eff').textContent=eff; if(reason) warn(reason); setScreen(scrResult); }

    on(btnStart,'click',start); on(btnPause,'click',pause); on(btnRestart,'click',start); on(btnMenu,'click',()=>setScreen(scrMenu));
    on(btnAudio,'click',(e)=>{ e.preventDefault(); toggleAudio(); });

    // Touch controls
    const holders=new Map();
    function addHold(el, action, initial=200, repeat=80){ if(!el) return; const start=(ev)=>{ ev.preventDefault(); if(!st.running||st.paused) return; action(); const t1=setTimeout(()=>{ const t2=setInterval(()=>action(), repeat); holders.set(el,{t1:null,t2}); }, initial); holders.set(el,{t1,t2:null}); }; const end=()=>{ const h=holders.get(el); if(h){ if(h.t1) clearTimeout(h.t1); if(h.t2) clearInterval(h.t2); holders.delete(el);} }; on(el,'pointerdown',start,{passive:false}); on(el,'pointerup',end); on(el,'pointerleave',end); on(el,'pointercancel',end); }
    addHold(tcLeft, ()=>move(-1));
    addHold(tcRight, ()=>move(1));
    addHold(tcDown, ()=>{ st.lastFall=0; });
    on(tcRotate,'pointerdown',(e)=>{ e.preventDefault(); if(!st.running||st.paused) return; rotate(); }, {passive:false});
    on(tcDrop,'pointerdown',(e)=>{ e.preventDefault(); if(!st.running||st.paused) return; drop(); }, {passive:false});
    on(tcPause,'pointerdown',(e)=>{ e.preventDefault(); pause(); }, {passive:false});

    // Canvas gestures
    let touchStart=null;
    on(board,'touchstart',(e)=>{ if(!st.running) return; const t=e.changedTouches[0]; touchStart={x:t.clientX,y:t.clientY,time:performance.now()}; e.preventDefault(); }, {passive:false});
    on(board,'touchend',(e)=>{ if(!st.running) return; const t=e.changedTouches[0]; if(!touchStart) return; const dx=t.clientX-touchStart.x, dy=t.clientY-touchStart.y; const dt=performance.now()-touchStart.time; const ax=Math.abs(dx), ay=Math.abs(dy); if(ax<12 && ay<12 && dt<180){ rotate(); } else if(ax>ay){ if(ax>20){ dx>0 ? move(1) : move(-1); } } else { if(dy>28){ drop(); } } touchStart=null; e.preventDefault(); }, {passive:false});

    console.log('Ship Tetris (mobile one‚Äëfile) ‚Äî –∑–≤—É–∫ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
  })();
  </script>
</body>
</html>

